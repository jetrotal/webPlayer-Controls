<html lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EasyRPG Player</title>
  <style>
    :root {
      --color-gray: hsl(0, 0%, 55%);
      --controls-size: 13vw;
    }

    @media (orientation: landscape) {
      :root {
        --controls-size: 13vh;
      }
    }

    html {
      touch-action: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      color: white;
      background: black;
    }

    .unselectable {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #status {
      font-size: 1.5rem;
      color: var(--color-gray);
      text-align: center;
    }

    #controls {
      position: relative;
      text-align: right;
      z-index: 10;
    }

    #controls button {
      -webkit-appearance: button;
      display: inline-flex;
      background: transparent;
      border: 0;
      color: white;
      font-family: inherit;
      font-size: 1em;
      line-height: inherit;
      cursor: pointer;
      padding: 0.5rem;
    }

    #controls svg {
      pointer-events: none;
    }

    #canvas {
      position: absolute;
      top: calc(50% - 2.5 * var(--controls-size));
      left: 50%;
      border: 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      transform: translate(-50%, -50%);
    }

    @media (orientation: landscape) {
      #canvas {
        top: 50%;
        left: calc(50% - 0.5 * var(--controls-size));
      }
    }

    #dpad,
    #apad {
      position: fixed;
      bottom: 1rem;
    }

    #dpad {
      left: 1rem;
    }

    #apad {
      right: 1rem;
    }

    #dpad svg {
      width: calc(3 * var(--controls-size));
      height: calc(3 * var(--controls-size));
      opacity: 0.2;
    }

    #apad svg {
      width: calc(4 * var(--controls-size));
      height: calc(4.5 * var(--controls-size));
      opacity: 0.2;
    }

    #f12button {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 10;
    }

    #f12button svg {
      width: calc(1.5 * var(--controls-size));
      height: calc(1 * var(--controls-size));
      opacity: 0.2;
    }

    #apad svg *, #dpad svg *, #f12button svg * {
      paint-order: stroke;
    }

    #controls-fullscreen {
      opacity: 0.2;
    }
    
    .active:not(.hidden-shape) {
      opacity: 0.8;
    }

    .active:not(.hidden-shape), .active:not(.hidden-shape) :not(text, tspan) {
      stroke:#FFF
    }

    .active text, .active tspan {
      stroke: none;
    }

    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&amp;display=swap');
    text {
      fill:white;
      stroke:none;
      text-anchor:middle;
      font-size:6px;
      font-family:'Nunito', sans-serif;
      dominant-baseline:middle;
    }
    #kmain circle {
      fill:white;
      stroke:#000;
    }
    #kmain path {
      fill:#808080;
    }
    #kmain path {

      stroke-width:0.5
    }
    #knum circle {
      fill:#808080;
      stroke:black;
    }
    #kspec circle {
      stroke:#808080;
    }
    
    #kspec path {
      fill:#808080;
    }

    @media (hover: hover) and (pointer: fine) {
      #apad,
      #dpad,
      #f12button {
        display: none;
      }
      #canvas {
        top: 50%;
        left: 50%;
      }
    }

    @media (min-width: 320px) and (min-height: 240px) { #canvas { width: 320px; height: 240px; } }
    @media (min-width: 640px) and (min-height: 480px) { #canvas { width: 640px; height: 480px; } }
    @media (min-width: 960px) and (min-height: 720px) { #canvas { width: 960px; height: 720px; } }
    @media (min-width: 1280px) and (min-height: 960px) { #canvas { width: 1280px; height: 960px; } }
    @media (min-width: 1600px) and (min-height: 1200px) { #canvas { width: 1600px; height: 1200px; } }
    @media (min-width: 1920px) and (min-height: 1440px) { #canvas { width: 1920px; height: 1440px; } }
    @media (min-width: 2240px) and (min-height: 1680px) { #canvas { width: 2240px; height: 1680px; } }
    @media (min-width: 2560px) and (min-height: 1920px) { #canvas { width: 2560px; height: 1920px; } }
    @media (min-width: 2880px) and (min-height: 2160px) { #canvas { width: 2880px; height: 2160px; } }
    @media (min-width: 3200px) and (min-height: 2400px) { #canvas { width: 3200px; height: 2400px; } }
    @media (min-width: 3520px) and (min-height: 2640px) { #canvas { width: 3520px; height: 2640px; } }
    @media (min-width: 3840px) and (min-height: 2880px) { #canvas { width: 3840px; height: 2880px; } }
    @media (min-width: 4160px) and (min-height: 3120px) { #canvas { width: 4160px; height: 3120px; } }
    @media (min-width: 4480px) and (min-height: 3360px) { #canvas { width: 4480px; height: 3360px; } }
    @media (min-width: 4800px) and (min-height: 3600px) { #canvas { width: 4800px; height: 3600px; } }
    @media (min-width: 5120px) and (min-height: 3840px) { #canvas { width: 5120px; height: 3840px; } }
    @media (min-width: 5440px) and (min-height: 4080px) { #canvas { width: 5440px; height: 4080px; } }
    @media (min-width: 5760px) and (min-height: 4320px) { #canvas { width: 5760px; height: 4320px; } }

  </style>
</head>
<body style="">
  <div id="controls">
    <button id="controls-fullscreen" class="unselectable">
      <svg viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" width="25" height="25"><path d="M13.5 13.5H10m3.5 0V10m0 3.5l-4-4m.5-8h3.5m0 0V5m0-3.5l-4 4M5 1.5H1.5m0 0V5m0-3.5l4 4m-4 4.5v3.5m0 0H5m-3.5 0l4-4" stroke="currentColor"></path></svg>
    </button>
  </div>

  <div id="status"></div>

  <canvas id="canvas" tabindex="-1" class="unselectable" width="960" height="720" style="cursor: default;"></canvas>

  <div id="f12button" class="unselectable">
    <svg width="15" height="10" version="1.1" viewBox="0 0 15 10" xmlns="http://www.w3.org/2000/svg">
      <g id="button-F12" data-key="F12" data-key-code="123">
        <path d="m5 .5h5a4.5 4.5 45 014.5 4.5 4.5 4.5 135 01-4.5 4.5h-5a4.5 4.5 45 01-4.5-4.5 4.5 4.5 135 014.5-4.5z" stroke="#808080"></path>
        <text x="7.4" y="5.6">F12</text>
      </g>
    </svg>
  </div>

  <div id="dpad" class="unselectable">
    <svg width="30" height="30" version="1.1" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
      <path id="dpad-up" data-key="ArrowUp" data-key-code="38" d="m12 .5c-.7854 0-1.5.7146-1.5 1.5v6.586c0 .7629.3141 1.521.8535 2.061l2.586 2.586c.5553.5552 1.566.5552 2.121 0l2.586-2.586c.5394-.5395.8535-1.298.8535-2.061v-6.586c0-.7854-.7146-1.5-1.5-1.5z" fill="#fff" stroke="#000" class=""></path>
      <path id="dpad-left" data-key="ArrowLeft" data-key-code="37" d="m2 10.5c-.7854 0-1.5.7146-1.5 1.5v6c0 .7854.7146 1.5 1.5 1.5h6.586c.7629 0 1.521-.3141 2.061-.8535l2.586-2.586c.5552-.5553.5552-1.566 0-2.121l-2.586-2.586c-.5395-.5394-1.298-.8535-2.061-.8535z" fill="#fff" stroke="#000"></path>
      <path id="dpad-down" data-key="ArrowDown" data-key-code="40" d="m15 16.33c-.3927 5.9e-5-.7829.1618-1.061.4395l-2.586 2.586c-.5394.5395-.8535 1.298-.8535 2.061v6.586c0 .7854.7146 1.5 1.5 1.5h6c.7854 0 1.5-.7146 1.5-1.5v-6.586c0-.7629-.3141-1.521-.8535-2.061l-2.586-2.586c-.2776-.2777-.6679-.4394-1.061-.4395z" fill="#fff" stroke="#000" class=""></path>
      <path id="dpad-right" data-key="ArrowRight" data-key-code="39" d="m21.41 10.5c-.7629 0-1.521.3141-2.061.8535l-2.586 2.586c-.5552.5553-.5552 1.566 0 2.121l2.586 2.586c.5395.5394 1.298.8535 2.061.8535h6.586c.7854 0 1.5-.7146 1.5-1.5v-6c0-.7854-.7146-1.5-1.5-1.5z" fill="#fff" stroke="#000"></path>
      <path id="dpad-up&amp;left" class="hidden-shape" data-key="ArrowUp&amp;ArrowLeft" data-key-code="38&amp;37" d="m11 .5586a15 15 0 00-10.44 10.44h8.441l4 4h2v-2l-4-4z" opacity="0"></path>
      <path id="dpad-left&amp;down" class="hidden-shape" data-key="ArrowLeft&amp;ArrowDown" data-key-code="37&amp;40" d="m13 15-4 4h-8.441a15 15 0 0010.44 10.44v-8.441l4-4v-2z" opacity="0"></path>
      <path id="dpad-down&amp;right" class="hidden-shape" data-key="ArrowDown&amp;ArrowRight" data-key-code="40&amp;39" d="m15 15v2l4 4v8.441a15 15 0 0010.44-10.44h-8.441l-4-4z" opacity="0"></path>
      <path id="dpad-right&amp;up" class="hidden-shape" data-key="ArrowRight&amp;ArrowUp" data-key-code="39&amp;38" d="m19 .5488v8.451l-4 4v2h2l4-4h8.451a15 15 0 00-10.45-10.45z" opacity="0"></path>
    </svg>
  </div>

  <div id="apad" class="unselectable">
    <svg xmlns="http://www.w3.org/2000/svg" style="overflow:visible" viewBox="0 0 45 50">
  <g data-key="Enter" data-key-code="13" transform="translate(3.9 -9.8)">
    <circle cx="25" cy="53.8" r="5.7"/>
    <path d="M26.6 53.4c0 .8-.6 1.4-1.4 1.4h-.5v.8l-1.3-1.2 1.3-1v.7h.5c.4 0 .6-.3.6-.7V52h.8v1.4Z"/>
  </g>
  <g data-key="Escape" data-key-code="27" transform="translate(5.8 -3.4) scale(.87878)">
    <circle cx="36.8" cy="42.9" r="6.5"/>
    <path d="M34.1 41.7h1.5v.5h-1v.4h1v.5h-1v.5h1v.5H34v-2.4m2.5 0h1v.5h-1v.4h.5c.2 0 .4.3.4.5v.5c0 .3-.2.5-.4.5h-1v-.5h1v-.5h-.5a.5.5 0 0 1-.5-.5v-.4c0-.3.2-.5.5-.5m2 0h.4c.3 0 .5.2.5.5v.2H39v-.2h-.5v1.4h.5v-.2h.5v.2c0 .3-.2.5-.5.5h-.5a.5.5 0 0 1-.5-.5v-1.4c0-.3.2-.5.5-.5Z"/>
  </g>
  <g data-key="Shift" data-key-code="16" transform="translate(.8 -10)">
    <circle cx="6.2" cy="53.8" r="5.7"/>
    <path d="M6.8 55v-1.2h.4l-1-1-1 1h.4V55h1.2m-.6-2.8 2 2h-1v1.2h-2v-1.2h-1l2-2Z"/>
  </g>
  <g data-key="0" data-key-code="96" transform="translate(4.3 1.8) scale(.87878)">
    <circle cx="15.6" cy="45" r="4.5"/>
    <path d="M15.4 44c-.2 0-.4.1-.4.4v1.2c0 .3.2.5.4.5h.4c.3 0 .5-.2.5-.5v-1.2c0-.3-.2-.5-.5-.5h-.4m0 .5h.4v1.2h-.4v-1.2Z"/>
  </g>
  <g data-key="1" data-key-code="97" transform="translate(3.8 1.3) scale(.87878)">
    <circle cx="5.6" cy="35" r="4.5"/>
    <path d="M5.2 34v.4h.4V36H6v-2.2h-.8Z"/>
  </g>
  <g data-key="2" data-key-code="98" transform="translate(4.3 1.2) scale(.87878)">
    <circle cx="15.6" cy="35" r="4.5"/>
    <path d="M15 34v.4h.8v.4h-.4c-.2 0-.4.2-.4.4v.9h1.3v-.5h-.9v-.4h.4c.3 0 .5-.2.5-.4v-.4c0-.3-.2-.5-.5-.5H15Z"/>
  </g>
  <g data-key="3" data-key-code="99" transform="translate(4.8 1.1) scale(.87878)">
    <circle cx="25.6" cy="35" r="4.5"/>
    <path d="M26.3 35.6v-.3c0-.2-.2-.3-.4-.3.2 0 .4-.1.4-.3v-.3c0-.3-.2-.5-.5-.5H25v.5h.8v.4h-.4v.4h.4v.4H25v.5h.8c.3 0 .5-.2.5-.5"/>
  </g>
  <g data-key="4" data-key-code="100" transform="translate(3.8 .8) scale(.87878)">
    <circle cx="5.6" cy="25" r="4.5"/>
    <path d="M5 24v1.2h.8v.9h.4v-2.2h-.4v.9h-.4v-.9H5Z"/>
  </g>
  <g data-key="5" data-key-code="101" transform="translate(4.3 .8) scale(.87878)">
    <circle cx="15.6" cy="25" r="4.5"/>
    <path d="M15 24v1.2h.8v.4H15v.5h.8c.3 0 .5-.2.5-.5v-.4c0-.2-.2-.4-.5-.4h-.4v-.4h.9v-.5H15Z"/>
  </g>
  <g data-key="6" data-key-code="102" transform="translate(4.8 .7) scale(.87878)">
    <circle cx="25.6" cy="25" r="4.5"/>
    <path d="M25.4 24c-.2 0-.4.1-.4.4v1.2c0 .3.2.5.4.5h.4c.3 0 .5-.2.5-.5v-.4c0-.2-.2-.4-.5-.4h-.4v-.4h.9v-.5h-.9m0 1.3h.4v.4h-.4v-.4Z"/>
  </g>
  <g data-key="7" data-key-code="103" transform="translate(3.9 .4) scale(.87878)">
    <circle cx="5.6" cy="15" r="4.5"/>
    <path d="m5.4 16 .8-1.6v-.5H5v.5h.8L5 16"/>
  </g>
  <g data-key="8" data-key-code="104" transform="translate(4.3 .3) scale(.87878)">
    <circle cx="15.6" cy="15" r="4.5"/>
    <path d="M15.4 15.2h.4v.4h-.4m0-1.2h.4v.4h-.4m0 1.3h.4c.3 0 .5-.2.5-.5v-.3c0-.2-.2-.3-.4-.3.2 0 .4-.1.4-.3v-.3c0-.3-.2-.5-.5-.5h-.4c-.2 0-.4.2-.4.5v.3c0 .2.1.3.3.3-.2 0-.3.1-.3.3v.3c0 .3.2.5.4.5"/>
  </g>
  <g data-key="9" data-key-code="105" transform="translate(4.8 .2) scale(.87878)">
    <circle cx="25.6" cy="15" r="4.5"/>
    <path d="M25.8 16c.3 0 .5-.1.5-.4v-1.2c0-.3-.2-.5-.5-.5h-.4c-.2 0-.4.2-.4.5v.4c0 .2.2.4.4.4h.4v.4H25v.5h.8m0-1.3h-.4v-.4h.4v.4Z"/>
  </g>
  <g data-key="/" data-key-code="111" transform="translate(-4.9 -.2) scale(.87278)">
    <circle cx="15.6" cy="5" r="4.5"/>
    <path d="m14.5 7 1.7-4h.5L15 7h-.5Z"/>
  </g>
  <g data-key="*" data-key-code="106" transform="translate(-4.2 -.3) scale(.87278)">
    <circle cx="25.6" cy="5" r="4.5"/>
    <path d="M26.7 5.1H26l.6.6-.2.2-.6-.6v.8h-.2v-.8l-.6.6-.2-.2.6-.6h-.8V5h.8l-.6-.6.2-.2.6.6V4h.2v.8l.6-.6.2.2-.6.6h.8Z"/>
  </g>
  <g data-key="-" data-key-code="109" transform="translate(-7.6 -6)">
    <circle cx="35" cy="10.1" r="3.9"/>
    <path d="M35.9 10.4h-1.8v-.5h1.8"/>
  </g>
  <g data-key="+" data-key-code="107" transform="translate(5.7 -13.6) scale(.88435)">
    <circle cx="35" cy="20" r="4.5"/>
    <path d="M35 19.6c-.2 0-.4.2-.4.4a.4.4 0 1 0 .8 0c0-.2-.2-.4-.4-.4Z"/>
  </g>
  <g data-key="." data-key-code="110" transform="translate(6 -13) scale(.87664)">
    <circle cx="35" cy="30" r="4.5"/>
    <path d="M36 30.3h-.7v.8h-.6v-.8H34v-.6h.8V29h.6v.8h.8v.6Z"/>
  </g>
  <g data-key="." transform="translate(6 -3.7) scale(.87878)">
    <circle cx="35" cy="30" r="4.5"/>
    <path d="M35.9 31.7h.8V31H36m0-.5h.8v-.8H36m-1.3-.5h.8v-.8h-.8m1.3.8h.8v-.8H36m-1.3 2.1h.8v-.8h-.8m-1.3.8h.8v-.8h-.8m0 2.1h.8V31h-.8m1.3.8h.8V31h-.8m-1.4-2h.8v-.8h-.8v.8Z"/>
  </g>
</svg>

  </div>

<script async="" type="text/javascript" src="index.js"></script>

<script>
const hasTouchscreen = window.matchMedia('(hover: none), (pointer: coarse)').matches;
const preventNativeKeys = ['ArrowUp', 'ArrowDown', 'ArrowRight', 'ArrowLeft', ' ', 'F12'];
const keys = new Map();
const keysDown = new Map();
const canvas = document.getElementById('canvas');
let lastTouchedId;

// Make EasyRPG player embeddable
canvas.addEventListener('mouseenter', () => window.focus());
canvas.addEventListener('click', () => window.focus());

// Handle clicking on the fullscreen button
document.querySelector('#controls-fullscreen').addEventListener('click', () => {
  if (hasTouchscreen) {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    }
  } else {
    if (canvas.requestFullscreen) {
      canvas.requestFullscreen();
    }
  }
});

/**
 * Simulate a keyboard event on the emscripten canvas
 *
 * @param {string} eventType Type of the keyboard event
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardEvent(eventType, key, keyCode) {
  // simulate multiple key events (data-key and data-key-code containing "&"):
  const mk = key.split('&');
  if (mk.length > 1) {
    const mkc = keyCode.split('&');
    mk.forEach((x, i) => {
      const node = document.querySelector('[data-key="' + x + '"]');
      if (eventType == 'keydown') node.classList.add('active');
      else node.classList.remove('active');
      simulateKeyboardEvent(eventType, x, mkc[i]);
    });
    return;
  }
  // simulate regular key event:
  const event = new Event(eventType, { bubbles: true });
  event.key = key;
  event.code = key;
  // Deprecated, but necessary for emscripten somehow
  event.keyCode = keyCode;
  event.which = keyCode;

  canvas.dispatchEvent(event);
}

/**
 * Simulate a keyboard input from `keydown` to `keyup`
 *
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function simulateKeyboardInput(key, keyCode) {
  simulateKeyboardEvent('keydown', key, keyCode);
  window.setTimeout(() => {
    simulateKeyboardEvent('keyup', key, keyCode);
  }, 100);
}

/**
 * Bind a node by a specific key to simulate on touch
 *
 * @param {*} node The node to bind a key to
 * @param {string} key Key to simulate
 * @param {number} keyCode Key code to simulate (deprecated)
 */
function bindKey(node, key, keyCode) {
  keys.set(node.id, { key, keyCode });

  node.addEventListener('touchstart', event => {
    event.preventDefault();
    simulateKeyboardEvent('keydown', key, keyCode);
    keysDown.set(event.target.id, node.id);
    node.classList.add('active');
  });

  node.addEventListener('touchend', event => {
    event.preventDefault();

    const pressedKey = keysDown.get(event.target.id);
    if (pressedKey && keys.has(pressedKey)) {
      const { key, keyCode } = keys.get(pressedKey);
      simulateKeyboardEvent('keyup', key, keyCode);
    }

    keysDown.delete(event.target.id);
    node.classList.remove('active');
  
    if (lastTouchedId) {
      document.getElementById(lastTouchedId).classList.remove('active');
    }
  });

  // Inspired by https://github.com/pulsejet/mkxp-web/blob/262a2254b684567311c9f0e135ee29f6e8c3613e/extra/js/dpad.js
  node.addEventListener('touchmove', event => {
    const { target, clientX, clientY } = event.changedTouches[0];
    const origTargetId = keysDown.get(target.id);
    const nextTarget = document.elementFromPoint(clientX, clientY);
    if (nextTarget === null) return;
    const nextTargetId = nextTarget.id;
    if (origTargetId === nextTargetId) return;

    if (origTargetId) {
      const { key, keyCode } = keys.get(origTargetId);
      simulateKeyboardEvent('keyup', key, keyCode);
      keysDown.delete(target.id);
      document.getElementById(origTargetId).classList.remove('active');
    }

    if (keys.has(nextTargetId)) {
      const { key, keyCode } = keys.get(nextTargetId);
      simulateKeyboardEvent('keydown', key, keyCode);
      keysDown.set(target.id, nextTargetId);
      lastTouchedId = nextTargetId;
      document.getElementById(nextTargetId).classList.add('active');
    }
  })
}

// Bind all elements providing a `data-key` attribute with the
// given key on touch-based devices
if (hasTouchscreen) {
  for (const button of document.querySelectorAll('[data-key]')) {
    bindKey(button, button.dataset.key, button.dataset.keyCode);
  }
} else {
  // Prevent scrolling when pressing specific keys
  window.addEventListener('keydown', event => {
    if (preventNativeKeys.includes(event.key)) {
      event.preventDefault();
    }
  });

  canvas.addEventListener('contextmenu', event => {
    event.preventDefault();
    // simulateKeyboardInput('Escape', 27);
  });

  // canvas.addEventListener('click', () => {
  //   simulateKeyboardInput('Enter', 13);
  // });
}
</script>


</body></html>
